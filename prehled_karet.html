<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Přehled karet – verze 1</title>
  <style>
    :root{
      --blue:#3d78d8;
      --blue-dark:#2f66c4;
      --sidebar-w:260px;
      --sidebar-w-collapsed:66px;
      --bg:#f2f4f7;
      --card:#ffffff;
      --line:#e6e9ef;
      --muted:#6b7280;
      --link:#1e66ff;
      --btn-blue:#2f66c4;
      --btn-red:#ef4444;
      --btn-purple:#7b1fa2;
      --shadow:0 1px 2px rgba(0,0,0,.08);
      --menu-gap: 6px;

      --user-orange: #ff8a2a;
      --user-orange-hover: #ff9b4d;
      --user-orange-active: #f07c1f;


      --settings-sep-color: #000;   /* barva čáry */
      --settings-sep-opacity: .2;  /* průhlednost */
      --settings-sep-thickness: 2px;/* tloušťka */
      --settings-sep-margin: 30px;  /* mezera nad/pod čárou */

      /* šířky sloupců (aby filtry seděly nad sloupce) */
      --c-user: 170px;
      --c-vs: 130px;
      --c-holder: 170px;
      --c-issued: 260px;
      --c-card: 170px;
      --c-status: 200px;
      --c-pay: 140px;
      --c-rej: 200px;
      --c-lastcmd: 260px;
      --c-edit: 70px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color:#111827;
    }

    /* Top bar */
    .topbar{
      position:fixed;
      top:0; left:0; right:0;
      height:56px;
      background: var(--blue);
      display:flex;
      align-items:center;
      padding:0 16px;
      z-index:50;
      box-shadow: var(--shadow);
    }
    .topbar .brand{
      display:flex;
      align-items:center;
      gap:10px;
      color:#fff;
      font-weight:700;
      letter-spacing:.2px;
    }
    .deploy-pill{
      display:inline-flex;
      align-items:stretch;
      border-radius:4px;
      overflow:hidden;
      box-shadow: 0 1px 0 rgba(0,0,0,.12);
      font-size:12px;
      font-weight:800;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .deploy-pill .left{
      background:#2f343b;
      color:#fff;
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
    }
    .deploy-pill .left .fb{
      width:16px; height:16px;
      border-radius:3px;
      background:#111;
      display:grid;
      place-items:center;
      font-size:12px;
      line-height:1;
    }
    .deploy-pill .right{
      background:#11a372;
      color:#fff;
      display:flex;
      align-items:center;
      padding:6px 10px;
      font-weight:900;
    }
    .topbar .spacer{ flex:1; }

    .topbar .userbtn{
      background: var(--user-orange);
      color:#fff;
      border:none;
      border-radius:6px;
      padding:7px 12px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.18);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .topbar .userbtn:hover{
      background: var(--user-orange-hover);
    }

    .topbar .userbtn:active{
      background: var(--user-orange-active);
      transform: translateY(1px);
    }


    /* Sidebar */
    .sidebar{
      position:fixed;
      top:56px; left:0; bottom:0;
      width:var(--sidebar-w);
      background:#fff;
      border-right:1px solid var(--line);
      padding:10px 10px 14px;
      overflow:auto;
      transition: width .18s ease;
    }
    body.sidebar-collapsed .sidebar{ width: var(--sidebar-w-collapsed); }

    .side-top{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 6px 10px;
      border-bottom:1px solid #f0f2f6;
      margin-bottom:10px;
    }
    .hamburger{
      width:34px; height:28px;
      border:1px solid #d7dce6;
      border-radius:4px;
      background:#fff;
      cursor:pointer;
      display:grid;
      place-items:center;
    }
    .hamburger:hover{ background:#f8fafc; }
    .hamburger .bars{
      width:16px; height:12px; position:relative;
    }
    .hamburger .bars::before,
    .hamburger .bars::after,
    .hamburger .bars span{
      content:"";
      position:absolute; left:0; right:0;
      height:2px; background:#6b7280; border-radius:2px;
    }
    .hamburger .bars::before{ top:0; }
    .hamburger .bars span{ top:5px; }
    .hamburger .bars::after{ bottom:0; }

    .side-title{
      font-size:12px;
      color:#6b7280;
      font-weight:800;
      letter-spacing:.02em;
      white-space:nowrap;
    }
    body.sidebar-collapsed .side-title{ display:none; }

    .menu a{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius:6px;
      text-decoration:none;
      color:#374151;
      font-size:13px;
      cursor:pointer;
      margin-bottom: var(--menu-gap);
      transition: background .12s ease, color .12s ease;
    }

    .menu a:hover{
      background:#fff7ed;
      color:#b45309;
    }

    .menu a:hover .txt{
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    .menu a:hover .mi{
      color:#f59e0b;
    }

    /* dělící čára nad Nastavením */
    .menu-parent{
      position: relative;
      margin-top: calc(var(--settings-sep-margin) + 6px);
    }

    .menu-parent::before{
      content:"";
      position:absolute;
      left:0;
      right:0;
      top: calc(-1 * var(--settings-sep-margin));
      height: var(--settings-sep-thickness);
      background: var(--settings-sep-color);
      opacity: var(--settings-sep-opacity);
    }



    .mi{ width:18px; height:18px; color:#9ca3af; flex:0 0 auto; }
    .mi svg{ width:18px; height:18px; display:block; fill: currentColor; }
    .menu .txt{ white-space:nowrap; }
    body.sidebar-collapsed .menu .txt{ display:none; }

    /* Main */
    .main{
      margin-left:var(--sidebar-w);
      padding:18px 16px;
      padding-top: 56px + 18px;
      transition: margin-left .18s ease;
    }
    body.sidebar-collapsed .main{ margin-left: var(--sidebar-w-collapsed); }

    .main-inner{
      padding-top: 18px;
      margin-top:56px;
      max-width:3440px;
    }

    /* Card */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:8px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-header{
      background: var(--blue);
      color:#fff;
      padding:12px 12px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    /* (2) Ikona karty */
    .card-icon{
      width:24px; height:24px;
      border-radius:4px;
      background: rgba(255,255,255,.18);
      display:grid;
      place-items:center;
      user-select:none;
    }
    .card-icon svg{ width:18px; height:18px; fill:#fff; display:block; }
    .card-header h2{
      margin:0;
      font-size:18px;
      font-weight:900;
    }
    .card-header .hdr-spacer{ flex:1; }
    .tiny-btn{
      border:1px solid rgba(255,255,255,.65);
      background: rgba(0,0,0,.08);
      color:#fff;
      font-weight:900;
      font-size:12px;
      padding:6px 10px;
      border-radius:4px;
      cursor:pointer;
    }

    .card-body{ padding:14px 14px 10px; }

    /* Actions row */
    .actions{
      display:flex;
      flex-direction:column;
      align-items:flex-end;   /* vše vpravo */
      gap:8px;
      margin-bottom:10px;
    }
    .actions-top,
    .actions-bottom{
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }

    .btn{
      border:none;
      border-radius:4px;
      padding:7px 10px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.06);
    }
    .btn-purple{ background: var(--btn-purple); color:#fff; padding:8px 14px; }
    .btn-blue{ background: var(--btn-blue); color:#fff; }
    .btn-red{ background: var(--btn-red); color:#fff; }
    .btn:active{ transform: translateY(1px); }
    .btn-orange{ background:#f59e0b; color:#fff; }


    .meta-inline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-size:12px;
      margin: 6px 0 8px;
    }
    .meta-inline b{ color:#111827; }

    .menu a.active{
      background:#ffedd5;
      color:#9a3412;
    }
    .menu a.active .mi{ color:#f59e0b; }
    .menu a.active .txt{
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    /* Table area */
    .table-shell{
      border-top:1px solid var(--line);
      margin-top:6px;
      height: calc(100vh - 56px - 18px - 18px - 120px);
      min-height: 320px;
      overflow:auto;
      background:#fff;
    }

    table{
      border-collapse:separate;
      border-spacing:0;
      width:100%;
      min-width: calc(
        var(--c-user) + var(--c-vs) + var(--c-holder) + var(--c-issued) + var(--c-card) +
        var(--c-status) + var(--c-pay) + var(--c-rej) + var(--c-lastcmd) + var(--c-edit)
      );
      font-size:12px;
      table-layout: fixed;
    }
    col.user{ width: var(--c-user); }
    col.vs{ width: var(--c-vs); }
    col.holder{ width: var(--c-holder); }
    col.issued{ width: var(--c-issued); }
    col.card{ width: var(--c-card); }
    col.status{ width: var(--c-status); }
    col.pay{ width: var(--c-pay); }
    col.rej{ width: var(--c-rej); }
    col.lastcmd{ width: var(--c-lastcmd); }
    col.edit{ width: var(--c-edit); }

    thead th{
      background:#fff;
      z-index:2;
      text-align:left;
      padding:8px 8px;
      border-bottom:1px solid var(--line);
      font-weight:900;
      color:#111827;
      white-space:nowrap;
    }
    thead tr.filters-row th{
      position:sticky;
      top:0;
      background:#fff;
      z-index:20;
      padding:6px 8px 8px;
      border-bottom:1px solid #eef1f6;
      height:46px;              /* FIX výška */
      vertical-align:middle;
    }

    thead tr.labels-row th{
      position:sticky;
      top:46px;                 /* MUSÍ sedět s height výš */
      background:#fff;
      z-index:10;
      padding:8px 8px;
      border-bottom:1px solid var(--line);
    }


    /* DŮLEŽITÉ: aby inputy šly vždy kliknout */
    thead tr.filters-row th{
      position: sticky;
    }
    thead tr.filters-row th,
    thead tr.filters-row th *{
      pointer-events: auto;
    }
    thead tr.filters-row th{
      isolation: isolate;       /* brání divným překryvům */
    }

    .finput, .fselect, .fdate{
      width:100%;
      border:1px solid #cfd6e1;
      border-radius:2px;
      height:26px;
      padding:0 8px;
      font-size:12px;
      background:#fff;
    }
    /* date input klikatelnost + vizuál */
    .fdate{
      cursor: pointer;
      position: relative;
      z-index: 2;
    }

    .date-2{ display:grid; grid-template-columns: 1fr 1fr; gap:6px; }

    tbody td{
      padding:8px 8px;
      border-bottom:1px solid #eef1f6;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    tbody tr:nth-child(odd){ background:#c0bebe; 
    }

    /* hover efekt na řádek tabulky */
    tbody tr{
      transition: background-color 0.12s ease;
    }

    tbody tr:hover{
      background-color:#a4a2a2; /* lehce tmavší než základ */
    }

    a.link{
      color:var(--link);
      text-decoration:underline;
      cursor:pointer;
    }
    .edit-btn{
      width:28px; height:22px;
      border:none;
      background:#2f66c4;
      color:#fff;
      border-radius:3px;
      font-weight:900;
      cursor:pointer;
    }
    .right{ text-align:right; }

    /* (4) šipky pro řazení v hlavičce */
    .th-flex{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .sort-arrows{
      display:inline-flex;
      gap:4px;
      align-items:center;
      flex:0 0 auto;
    }
    
    .sbtn{
      width:22px; height:22px;
      border:1px solid #b8c3d6;
      border-radius:4px;
      background:#e9f0ff;          /* světle modrá */
      cursor:pointer;
      display:grid;
      place-items:center;
      color:#1f4fa3;               /* modrá šipka */
      line-height:1;
      font-weight:900;
      user-select:none;
      transition: background .12s ease, border-color .12s ease, color .12s ease;
    }
    .sbtn:hover{
      background:#dbe8ff;
      border-color:#9fb3d7;
    }
    .sbtn.active{
      background:#ffe3e3;          /* světle červená */
      border-color:#ff6b6b;
      color:#c81e1e;               /* červená šipka */
      box-shadow: inset 0 0 0 1px rgba(200,30,30,.15);
    }

    /* Pager (rotátor stránek) */
    .pager{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      user-select:none;
      min-height:32px;
    }

    .pager-bottom{
      margin-top:10px;
    }

    .pager .pnums{
      display:inline-flex;
      gap:6px;
      flex: 0 0 auto;
    }

    .pbtn{
      height:28px;
      min-width:28px;
      padding:0 8px;
      border:1px solid #b8c3d6;
      border-radius:6px;
      background:#e9f0ff;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      color:#1f4fa3;
      line-height:1;
    }

    .pbtn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .pbtn:hover:not(:disabled){
      background:#dbe8ff;
      border-color:#9fb3d7;
    }

    .pbtn.active{
      background:#ffe3e3;
      border-color:#ff6b6b;
      color:#c81e1e;
      box-shadow: inset 0 0 0 1px rgba(200,30,30,.15);
    }

    .pbtn-nav{
      padding:0 10px;
    }

  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <span style="font-size:22px;">RP</span>

      <div class="deploy-pill" title="rychlapenezenka.cz">
        <div class="left">
          <span class="fb">f</span>
          <span>rychlapenezenka.cz</span>
        </div>
        <div class="right">deployed (N/A) 5 days ago</div>
      </div>
    </div>
    <div class="spacer"></div>
    <button class="userbtn">● Patrik Denemark ▾</button>
  </div>

  <aside class="sidebar">
    <!-- (1) Hamburger v sidebaru hned nahoře -->
    <div class="side-top">
      <button class="hamburger" id="hamburger" title="Menu">
        <div class="bars"><span></span></div>
      </button>
      <div class="side-title">Menu</div>
    </div>

    <div class="menu">
      <a href="prehled_stavu.html" data-nav="overview">
        <span class="mi"><svg viewBox="0 0 24 24"><path d="M12 3 3 10v11h6v-7h6v7h6V10z"/></svg></span>
        <span class="txt">Přehled stavu</span>
      </a>

      <a href="zakaznicke_ucty.html" data-nav="accounts">
        <span class="mi"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 3-1.34 3-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3ZM8 11c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3Zm0 2c-2.67 0-8 1.34-8 4v2h10v-2c0-1.14.4-2.1 1.05-2.9C10.2 13.4 9.1 13 8 13Zm8 0c-1.1 0-2.2.4-3.05 1.1.65.8 1.05 1.76 1.05 2.9v2h10v-2c0-2.66-5.33-4-8-4Z"/></svg></span>
        <span class="txt">Zákaznické účty</span>
      </a>

      <a href="vsechny_transakce.html" data-nav="tx">
        <span class="mi"><svg viewBox="0 0 24 24"><path d="M3 4h18v4H3V4Zm0 6h18v10H3V10Zm4 3v2h6v-2H7Z"/></svg></span>
        <span class="txt">Všechny transakce</span>
      </a>

      <a href="/poplatky" data-nav="fees">
        <span class="mi"><svg viewBox="0 0 24 24"><path d="M12 1 3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4Zm0 11h7c-.53 3.79-3.28 7.2-7 8.48V12H5V6.3l7-3.11V12Z"/></svg></span>
        <span class="txt">Všechny poplatky</span>
      </a>

      <a href="prehled_karet.html" data-nav="cards">
        <span class="mi"><svg viewBox="0 0 24 24"><path d="M20 6H4c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2Zm0 10H4V8h16v8Zm-2-6H6v2h12v-2Z"/></svg></span>
        <span class="txt">Přehled karet</span>
      </a>

      <a href="#" data-nav="notif">
        <span class="mi"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2Zm6-6V11c0-3.07-1.63-5.64-4.5-6.32V4a1.5 1.5 0 0 0-3 0v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2Z"/></svg></span>
        <span class="txt">Notifikace</span>
      </a>

      <a href="/bonusy" data-nav="bonus">
        <span class="mi"><svg viewBox="0 0 24 24"><path d="M12 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm0 2c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4Zm-7 10v2h14v-2H5Z"/></svg></span>
        <span class="txt">Bonusy a srážky</span>
      </a>

      <a href="/odstavky" data-nav="outages">
        <span class="mi"><svg viewBox="0 0 24 24"><path d="M19 4H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2Zm0 14H5V8h14v10Zm-2-8H7v2h10v-2Z"/></svg></span>
        <span class="txt">Provozní odstávky</span>
      </a>

      <a href="statistika_a_uzaverky.html" data-nav="stats">
        <span class="mi"><svg viewBox="0 0 24 24"><path d="M4 4a1 1 0 0 1 1 1v14h15a1 1 0 1 1 0 2H4a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1Zm3.2 11.6 3.6-3.6 2.7 2.7 5.3-6.4a1 1 0 1 1 1.5 1.3l-6 7.2a1 1 0 0 1-1.5.1L10.8 14l-2.1 2.1a1 1 0 1 1-1.4-1.4Z"/></svg></span>
        <span class="txt">Statistika a uzávěrky</span>
      </a>

      <a href="/logy" data-nav="logs">
        <span class="mi"><svg viewBox="0 0 24 24"><path d="M3 17h18v2H3v-2Zm0-5h18v2H3v-2Zm0-5h18v2H3V7Z"/></svg></span>
        <span class="txt">Logy</span>
      </a>

      <!-- "Nastavení" jako sekce/oddělovač (ne dropdown) -->
      <a href="/nastaveni" class="menu-parent" data-nav="settings">
        <span class="mi">
          <svg viewBox="0 0 24 24">
            <path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm10 4a8.1 8.1 0 0 0-.14-1.5l2.02-1.57-2-3.46-2.45 1a8.2 8.2 0 0 0-2.6-1.5l-.37-2.6H9.54l-.37 2.6a8.2 8.2 0 0 0-2.6 1.5l-2.45-1-2 3.46L2.14 10.5A8.1 8.1 0 0 0 2 12c0 .5.05 1 .14 1.5l-2.02 1.57 2 3.46 2.45-1a8.2 8.2 0 0 0 2.6 1.5l.37 2.6h4.92l.37-2.6a8.2 8.2 0 0 0 2.6-1.5l2.45 1 2-3.46-2.02-1.57c.09-.5.14-1 .14-1.5Z"/>
          </svg>
        </span>
        <span class="txt">Nastavení</span>
      </a>

      <a href="/sledovani" data-nav="work">
        <span class="mi"><svg viewBox="0 0 24 24"><path d="M3 13h2v8H3v-8Zm4-6h2v14H7V7Zm4 4h2v10h-2V11Zm4-8h2v18h-2V3Zm4 10h2v8h-2v-8Z"/></svg></span>
        <span class="txt">Sledování činnosti práce</span>
      </a>

      <a href="/emaily" data-nav="emails">
        <span class="mi"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2Zm0 4-8 5-8-5V6l8 5 8-5v2Z"/></svg></span>
        <span class="txt">Odesílání e-mailů</span>
      </a>

      <a href="/status" data-nav="status">
        <span class="mi"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm1 11H7v-2h6V5h2v8Z"/></svg></span>
        <span class="txt">Status RP</span>
      </a>
    </div>



  </aside>

  <main class="main">
    <div class="main-inner">
      <section class="card">
        <div class="card-header">
          <div class="card-icon" aria-hidden="true" title="Karta">
            <svg viewBox="0 0 24 24">
              <path d="M20 6H4c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2Zm0 10H4V12h16v4Zm0-6H4V8h16v2Z"/>
            </svg>
          </div>

          <h2>Přehled karet</h2>

          <!-- ROTÁTOR (nahoře, uprostřed) -->
          <div class="hdr-spacer"></div>
          <div class="pager pager-top" id="pagerTop" aria-label="Stránkování (horní)"></div>
          <div class="hdr-spacer"></div>

          <button class="tiny-btn">.pdf</button>
          <button class="tiny-btn">.csv</button>
        </div>

        <div class="card-body">
          <div class="actions">
            <div class="actions-top">
              <button class="btn btn-purple">Zrušit všechny mé rezervace</button>
            </div>
            <div class="actions-bottom">
              <button id="btnUnused" class="btn btn-orange">Nepoužité</button>
              <button id="btnFilter" class="btn btn-blue">Filtr</button>
              <button id="btnReset" class="btn btn-red">Reset</button>
            </div>
          </div>

          <!-- info o zobrazení -->
          <div id="metaInfo" class="meta-inline"></div>

          <div class="table-shell" id="tableShell">
            <table>
              <colgroup>
                <col class="user"><col class="vs"><col class="holder"><col class="issued"><col class="card">
                <col class="status"><col class="pay"><col class="rej"><col class="lastcmd"><col class="edit">
              </colgroup>

              <thead>
                <tr class="filters-row">
                  <th><input id="fUserName" class="finput" type="text" placeholder="Jméno uživatele"></th>
                  <th><input id="fVS" class="finput" type="text" placeholder="VS"></th>
                  <th><input id="fHolder" class="finput" type="text" placeholder="Držitel"></th>
                  <th>
                    <div class="date-2">
                      <input id="fIssuedFrom" class="fdate" type="date" title="Datum vydání – od">
                      <input id="fIssuedTo" class="fdate" type="date" title="Datum vydání – do">
                    </div>
                  </th>
                  <th><input id="fCard" class="finput" type="text" placeholder="Číslo karty"></th>
                  <th>
                    <select id="fStatus" class="fselect">
                      <option value="">Všechny</option>
                      <option>Vydaná bez nastavení</option>
                      <option>Vydaná</option>
                      <option>Blokovaná provozovatelem</option>
                      <option>Blokovaná uživatelem</option>
                      <option>Vydaná ve výpovědi</option>
                      <option>Zrušená uživatelem</option>
                      <option>Zrušená provozovatelem</option>
                      <option>Expirovala</option>
                    </select>
                  </th>
                  <th style="color:#9ca3af;font-weight:900;">—</th>
                  <th style="color:#9ca3af;font-weight:900;">—</th>
                  <th>
                    <div class="date-2">
                      <input id="fLastCmdFrom" class="fdate" type="date" title="Poslední platba kartou – od">
                      <input id="fLastCmdTo" class="fdate" type="date" title="Poslední platba kartou – do">
                    </div>
                  </th>
                  <th class="right" style="color:#9ca3af;font-weight:900;">—</th>
                </tr>

                <tr class="labels-row">
                  <th>Jméno uživatele</th>
                  <th>VS uživatele</th>
                  <th>Držitel karty</th>

                  <th>
                    <div class="th-flex">
                      <span>Datum vydání karty</span>
                      <span class="sort-arrows" aria-label="Řazení datum vydání">
                        <span class="sbtn" id="sortIssuedAsc" title="Řadit Datum vydání od nejstaršího">↑</span>
                        <span class="sbtn" id="sortIssuedDesc" title="Řadit Datum vydání od nejnovějšího">↓</span>
                      </span>
                    </div>
                  </th>

                  <th>Číslo karty</th>
                  <th>Stav karty</th>
                  <th>Platby kartou</th>
                  <th>Zamítnuté karetní příkazy</th>

                  <th>
                    <div class="th-flex">
                      <span>Poslední platba kartou</span>
                      <span class="sort-arrows" aria-label="Řazení poslední platba kartou">
                        <span class="sbtn" id="sortCmdAsc" title="Řadit Poslední platba kartou od nejstaršího">↑</span>
                        <span class="sbtn" id="sortCmdDesc" title="Řadit Poslední platba kartou od nejnovějšího">↓</span>
                      </span>
                    </div>
                  </th>

                  <th class="right">Editace</th>
                </tr>
              </thead>

              <tbody id="tbody"></tbody>
            </table>
          </div>

          <!-- ROTÁTOR (dole, uprostřed) -->
          <div class="pager pager-bottom" id="pagerBottom" aria-label="Stránkování (spodní)"></div>
        </div>
      </section>
    </div>
  </main>

  <script>
  /*****************************************************************
   * KONFIGURACE ODKAZŮ (doplň si svoje URL šablony)
   * Placeholdery: {vs} {cardId} {cardMasked}
   *****************************************************************/
  const LINK_TEMPLATES = {
    userName:   "#", // např. "/admin/uzivatel/{vs}"
    holder:     "#", // např. "/admin/drzitel/{cardId}"
    payments:   "#", // např. "/admin/karty/{cardId}/transakce"
    rejected:   "#", // např. "/admin/karty/{cardId}/zamítnuté"
    edit:       "#", // např. "/admin/karty/{cardId}/edit"
  };
  function buildUrl(template, row){
    if (!template) return "#";
    return template
      .replaceAll("{vs}", String(row.vs))
      .replaceAll("{cardId}", String(row.cardId))
      .replaceAll("{cardMasked}", String(row.cardMasked));
  }

  /*****************************************************************
   * STRÁNKOVÁNÍ
   *****************************************************************/
  const PAGE_SIZE = 500;
  let currentPage = 1;

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  function getTotalPages(totalRows){
    return Math.max(1, Math.ceil((totalRows || 0) / PAGE_SIZE));
  }
  function scrollTableToTop(){
    const shell = document.getElementById("tableShell");
    shell.scrollTop = 0;
  }

  function scrollTableToBottom(){
    const shell = document.getElementById("tableShell");
    shell.scrollTop = shell.scrollHeight;
  }

  function setPage(p, scrollMode = "none"){
    const totalPages = getTotalPages(VIEW_ROWS.length);
    currentPage = clamp(p, 1, totalPages);
    renderCurrentPage();

    if (scrollMode === "top") scrollTableToTop();
    if (scrollMode === "bottom") scrollTableToBottom();
  }

  function getPageSlice(rows){
    const totalPages = getTotalPages(rows.length);
    currentPage = clamp(currentPage, 1, totalPages);
    const start = (currentPage - 1) * PAGE_SIZE;

    let slice = rows.slice(start, start + PAGE_SIZE);

    // Když řadíme podle "Datum vydání", chceme N/A vždy dole na KAŽDÉ stránce
    if (sortState.by === "issuedAt") {
      const withPay = [];
      const naRows = [];
      for (const r of slice) {
        if (r.lastCommandAt) withPay.push(r);
        else naRows.push(r);
      }
      slice = withPay.concat(naRows);
    }

    return slice;
  }

  /*****************************************************************
   * ROTÁTOR (max 9 čísel + ⏮ ◀ ▶ ⏭)
   *****************************************************************/
  const pagerTop = document.getElementById("pagerTop");
  const pagerBottom = document.getElementById("pagerBottom");

  function buildPagerWindow(page, totalPages){
    const maxNums = 9;
    const half = 4; // 4 dozadu + 4 dopředu

    let start = Math.max(1, page - half);
    let end = start + (maxNums - 1);

    if (end > totalPages){
      end = totalPages;
      start = Math.max(1, end - (maxNums - 1));
    }

    const nums = [];
    for(let i=start;i<=end;i++) nums.push(i);
    return nums;
  }

  function pagerButton({label, title, disabled, active, kind}){
    const cls = [
      "pbtn",
      kind ? `pbtn-${kind}` : "",
      active ? "active" : "",
    ].filter(Boolean).join(" ");
    return `<button class="${cls}" type="button" ${disabled ? "disabled" : ""} title="${title || ""}" data-pagebtn>${label}</button>`;
  }

  function renderPager(){
    const totalPages = getTotalPages(VIEW_ROWS.length);
    const nums = buildPagerWindow(currentPage, totalPages);

    const canPrev = currentPage > 1;
    const canNext = currentPage < totalPages;

    const html = `
      ${pagerButton({label:"⏮", title:"Na začátek", disabled:!canPrev, kind:"nav"})}
      ${pagerButton({label:"◀", title:"O stránku zpět", disabled:!canPrev, kind:"nav"})}

      <span class="pnums">
        ${nums.map(n => pagerButton({label:String(n), title:`Stránka ${n}`, disabled:false, active:n===currentPage, kind:"num"})).join("")}
      </span>

      ${pagerButton({label:"▶", title:"O stránku dál", disabled:!canNext, kind:"nav"})}
      ${pagerButton({label:"⏭", title:"Na konec", disabled:!canNext, kind:"nav"})}
    `;

    pagerTop.innerHTML = html;
    pagerBottom.innerHTML = html;

    // napojení kliků (pro oba pagery stejné)
    const bind = (root, mode) => {
      const btns = [...root.querySelectorAll("button[data-pagebtn]")];
      if(btns.length === 0) return;

      // pořadí: ⏮, ◀, (1..9), ▶, ⏭
      const first = btns[0];
      const prev  = btns[1];
      const next  = btns[btns.length - 2];
      const last  = btns[btns.length - 1];
      const numBtns = btns.slice(2, btns.length - 2);

      first.addEventListener("click", () => setPage(1, mode));
      prev.addEventListener("click",  () => setPage(currentPage - 1, mode));
      next.addEventListener("click",  () => setPage(currentPage + 1, mode));
      last.addEventListener("click",  () => setPage(getTotalPages(VIEW_ROWS.length), mode));

      numBtns.forEach(b => {
        const n = Number(b.textContent.trim());
        b.addEventListener("click", () => setPage(n, mode));
      });
    };

    bind(pagerTop, "top");       // klik nahoře => skočit nahoru
    bind(pagerBottom, "bottom"); // klik dole  => zůstat dole

    // počkej na layout po innerHTML
    requestAnimationFrame(() => {
      keepActiveVisible(pagerTop);
      keepActiveVisible(pagerBottom);
    });
  }

  /*****************************************************************
   * (3) UNIQUE "Jméno uživatele" + římské číslice (II, III, ...)
   *****************************************************************/
  function toRoman(n){
    // n >= 2
    const map = [
      [1000,"M"],[900,"CM"],[500,"D"],[400,"CD"],
      [100,"C"],[90,"XC"],[50,"L"],[40,"XL"],
      [10,"X"],[9,"IX"],[5,"V"],[4,"IV"],[1,"I"]
    ];
    let x = n, out = "";
    for(const [v,s] of map){
      while(x >= v){ out += s; x -= v; }
    }
    return out;
  }

  function stripRomanSuffix(name){
    return String(name).replace(/\s+\([IVXLCDM]+\)\s*$/i, "").trim();
  }

  /*****************************************************************
   * FAKE DATA
   *****************************************************************/
  const SPECIAL_BASE_NAMES = [
    "Patrik Denemark",
    "Jaroslav Fikar",
    "Jakub Studnička",
    "Monika Zezulová",
    "Adam Děkan"
  ];

  const FIRST_NAMES = [
    "Pavel","Honza","Jan","Petr","Lukáš","Tomáš","Martin","Michal","David","Jakub","Vojtěch","Filip","Ondřej","Radek","Marek","Roman","Karel","Milan","Štěpán","Daniel","Jindřich","Matěj","Jiří","Zdeněk","Jaroslav","Oldřich","Igor","Aleš","Bohumil","Ivo","Vladimír","Richard","Rostislav","Stanislav","Miroslav","Sebastian","Oskar","Albert","Erik","Adam","Šimon","Tadeáš","Svatopluk",
    "Tereza","Jana","Petra","Lucie","Monika","Veronika","Klára","Barbora","Eliška","Kateřina","Karolína","Adéla","Nikola","Kristýna","Anna","Alena","Ivana","Lenka","Hana","Markéta","Magdalena","Dominika","Natálie","Nela","Sára","Patricie","Simona","Zuzana","Vendula","Michaela","Gabriela","Ema","Nikol","Denisa","Renata","Radka","Jitka","Šárka","Blažena"
  ];

  const LAST_NAMES = [
    "Vrba","Kočár","Novák","Svoboda","Dvořák","Černý","Procházka","Kučera","Veselý","Horák","Němec","Pokorný","Král","Růžička","Beneš",
    "Fiala","Sedláček","Jelínek","Kolář","Navrátil","Čermák","Vaněk","Šimek","Kříž","Blažek","Sýkora","Kratochvíl","Říha","Toman","Pospíšil",
    "Mareš","Urban","Šťastný","Bartoš","Konečný","Holub","Čížek","Staněk","Kadlec","Doležal","Vlk","Beran","Liška","Soukup","Škoda","Malý","Moravec",
    "Zeman","Křížek","Hruška","Němec","Černá","Novotný","Šafář","Mach","Bureš","Tichý","Vávra","Pech","Vítek","Janda","Zajíček","Kohout"
  ];

  const STATUSES = [
    "Vydaná bez nastavení",
    "Vydaná",
    "Blokovaná provozovatelem",
    "Blokovaná uživatelem",
    "Vydaná ve výpovědi",
    "Zrušená uživatelem",
    "Zrušená provozovatelem",
    "Expirovala"
  ];

  function pad(n){ return String(n).padStart(2,"0"); }
  function toISODate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function maskCard(num16){
    const s = String(num16);
    return s.slice(0,6) + "******" + s.slice(-4);
  }
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }
  }
  const rnd = mulberry32(20260105);
  function randomInt(min, max){ return Math.floor(rnd()*(max-min+1))+min; }

  function randomCzechName(){
    const fn = FIRST_NAMES[randomInt(0, FIRST_NAMES.length-1)];
    const ln = LAST_NAMES[randomInt(0, LAST_NAMES.length-1)];
    return `${fn} ${ln}`;
  }

  function makeRows(paidCount = 1200, naCount = 50, naOldCount = 50){
    const rows = [];
    const base = new Date(2025, 10, 1);    // 1.11.2025 (běžná data)
    const baseOld = new Date(2025, 0, 1);  // 1.1.2025 (staré N/A)
    const MAX_REPEAT_SPECIAL = 6;

    const totalNeeded = paidCount + naCount + naOldCount;

    // připrav si zásobník unikátních "base" jmen (včetně special)
    const baseSet = new Set();
    SPECIAL_BASE_NAMES.forEach(n => baseSet.add(n));

    const targetBase = Math.min(totalNeeded + 400, 5000);
    while (baseSet.size < targetBase){
      baseSet.add(randomCzechName());
    }
    const baseNames = Array.from(baseSet);

    // ============================================================
    // 1) VYGENERUJ "picked" TAK, ABY SPECIAL BYLY VŽDY SEKVENČNĚ:
    //    Patrik Denemark
    //    Patrik Denemark (II)
    //    Patrik Denemark (III) ...
    // ============================================================
    const picked = [];

    // 1a) nejdřív special jména vždy v pořadí a bez přeskoků
    for (const bn of SPECIAL_BASE_NAMES){
      for (let i = 1; i <= MAX_REPEAT_SPECIAL; i++){
        picked.push(i === 1 ? bn : `${bn} (${toRoman(i)})`);
        if (picked.length >= totalNeeded) break;
      }
      if (picked.length >= totalNeeded) break;
    }

    // 1b) zbytek doplň náhodnými "normálními" jmény (bez special)
    const normalBaseNames = baseNames.filter(n => !SPECIAL_BASE_NAMES.includes(n));

    // shuffle normálních jmen (deterministicky díky randomInt/rnd)
    for (let i = normalBaseNames.length - 1; i > 0; i--) {
      const j = randomInt(0, i);
      [normalBaseNames[i], normalBaseNames[j]] = [normalBaseNames[j], normalBaseNames[i]];
    }

    for (const n of normalBaseNames){
      if (picked.length >= totalNeeded) break;
      picked.push(n);
    }

    // ============================================================
    // 2) Z "picked" vyrob řádky (Paid / N/A / OLD N/A)
    // ============================================================

    // Paid
    for (let i = 0; i < Math.min(paidCount, picked.length); i++){
      const userName = picked[i];
      const holderName = stripRomanSuffix(userName);

      const vs = String(randomInt(41000000, 98999999));
      const status = STATUSES[randomInt(0, STATUSES.length - 1)];

      const issued = new Date(base);
      issued.setDate(issued.getDate() + randomInt(0, 120));

      const lastCmd = new Date(issued);
      lastCmd.setDate(lastCmd.getDate() + randomInt(0, 60));

      const cardId = 10000 + i;
      const cardNum = "474367" + String(randomInt(1000000000, 9999999999));
      const cardMasked = maskCard(cardNum);

      rows.push({
        cardId,
        userName,
        vs,
        holderName,
        issuedAt: toISODate(issued),
        cardMasked,
        status,
        lastCommandAt: toISODate(lastCmd),
      });
    }

    // N/A (novější)
    const startIdx = Math.min(paidCount, picked.length);
    for (let k = 0; k < naCount && (startIdx + k) < picked.length; k++){
      const userName = picked[startIdx + k];
      const holderName = stripRomanSuffix(userName);

      const vs = String(randomInt(41000000, 98999999));
      const status = STATUSES[randomInt(0, STATUSES.length - 1)];

      const issued = new Date(base);
      issued.setDate(issued.getDate() + randomInt(0, 120));

      const cardId = 10000 + startIdx + k;
      const cardNum = "474367" + String(randomInt(1000000000, 9999999999));
      const cardMasked = maskCard(cardNum);

      rows.push({
        cardId,
        userName,
        vs,
        holderName,
        issuedAt: toISODate(issued),
        cardMasked,
        status,
        lastCommandAt: "",
      });
    }

    // OLD N/A
    const oldStartIdx = startIdx + naCount;
    for (let k = 0; k < naOldCount && (oldStartIdx + k) < picked.length; k++){
      const userName = picked[oldStartIdx + k];
      const holderName = stripRomanSuffix(userName);

      const vs = String(randomInt(41000000, 98999999));
      const status = STATUSES[randomInt(0, STATUSES.length - 1)];

      const issued = new Date(baseOld);
      issued.setDate(issued.getDate() + randomInt(0, 220));

      const cardId = 10000 + oldStartIdx + k;
      const cardNum = "474367" + String(randomInt(1000000000, 9999999999));
      const cardMasked = maskCard(cardNum);

      rows.push({
        cardId,
        userName,
        vs,
        holderName,
        issuedAt: toISODate(issued),
        cardMasked,
        status,
        lastCommandAt: "",
      });
    }

    return rows;
  }

  const ALL_ROWS = makeRows(1200, 50, 50);
  let VIEW_ROWS = [...ALL_ROWS];


  /*****************************************************************
   * RENDER
   *****************************************************************/
  const tbody = document.getElementById("tbody");
  const metaInfo = document.getElementById("metaInfo");

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function formatCzDate(iso){
    if(!iso) return "";
    const [y,m,d] = iso.split("-");
    return `${Number(d)}.${Number(m)}.${y}`;
  }

  function formatLastPayment(iso){
    if(!iso) return "N/A";
    return formatCzDate(iso);
  }

  function render(rows){
    const shell = document.getElementById("tableShell");
    const prevTop = shell.scrollTop;
    const prevLeft = shell.scrollLeft;

    tbody.innerHTML = rows.map(r => `
      <tr>
        <td><a class="link" href="${buildUrl(LINK_TEMPLATES.userName, r)}" data-noop>${escapeHtml(r.userName)}</a></td>
        <td>${escapeHtml(r.vs)}</td>
        <td><a class="link" href="${buildUrl(LINK_TEMPLATES.holder, r)}" data-noop>${escapeHtml(r.holderName)}</a></td>
        <td>${formatCzDate(r.issuedAt)}</td>
        <td>${escapeHtml(r.cardMasked)}</td>
        <td>${escapeHtml(r.status)}</td>
        <td><a class="link" href="${buildUrl(LINK_TEMPLATES.payments, r)}" data-noop>Výpis transakcí</a></td>
        <td><a class="link" href="${buildUrl(LINK_TEMPLATES.rejected, r)}" data-noop>Výpis zamítnutých transakcí</a></td>
        <td>${escapeHtml(formatLastPayment(r.lastCommandAt))}</td>
        <td class="right"><a href="${buildUrl(LINK_TEMPLATES.edit, r)}" data-noop><button class="edit-btn" title="Edit">✎</button></a></td>
      </tr>
    `).join("");

    // zachovej scroll
    shell.scrollTop = prevTop;
    shell.scrollLeft = prevLeft;
  }

  function renderCurrentPage(){
    const pageRows = getPageSlice(VIEW_ROWS);
    render(pageRows);
    renderPager();
  }

  /*****************************************************************
   * Filtry + řazení
   *****************************************************************/
  const el = (id) => document.getElementById(id);
  function normalize(s){ return String(s||"").trim().toLowerCase(); }

  function inRange(dateIso, fromIso, toIso){
    if(!dateIso){
      return !(fromIso || toIso);
    }
    if(fromIso && dateIso < fromIso) return false;
    if(toIso && dateIso > toIso) return false;
    return true;
  }

  function romanToInt(roman){
    if(!roman) return 0;
    const map = {I:1,V:5,X:10,L:50,C:100,D:500,M:1000};
    let s = roman.toUpperCase();
    let total = 0;
    for(let i=0;i<s.length;i++){
      const v = map[s[i]] || 0;
      const next = map[s[i+1]] || 0;
      total += (next > v) ? -v : v;
    }
    return total;
  }

  function czCmp(a, b){
    return String(a).localeCompare(String(b), "cs", { sensitivity: "base" });
  }

  function nameSortKey(userName){
    const raw = String(userName || "").trim();

    const m = raw.match(/\s+\(([IVXLCDM]+)\)\s*$/i);
    const roman = m ? m[1] : "";
    const base = raw.replace(/\s+\([IVXLCDM]+\)\s*$/i, "").trim();

    const parts = base.split(/\s+/).filter(Boolean);

    const last = (parts.length ? parts[parts.length - 1] : "");
    const first = (parts.slice(0, -1).join(" ") || "");

    return {
      last,
      first,
      romanN: romanToInt(roman),
      full: base,
    };
  }

  function compareUserBySurname(a, b){
    const A = nameSortKey(a.userName);
    const B = nameSortKey(b.userName);

    let c = czCmp(A.last, B.last);
    if (c !== 0) return c;

    c = czCmp(A.first, B.first);
    if (c !== 0) return c;

    if (A.romanN !== B.romanN) return A.romanN < B.romanN ? -1 : 1;

    return czCmp(A.full, B.full);
  }

  function compareWithNA(by, dir, a, b){
    if (by === "userNameSurname"){
      const cmpN = compareUserBySurname(a, b);
      return dir === "asc" ? cmpN : -cmpN;
    }

    const av = a[by] || "";
    const bv = b[by] || "";

    if(by === "lastCommandAt"){
      const aNA = !av;
      const bNA = !bv;
      if(aNA && !bNA) return 1;
      if(!aNA && bNA) return -1;
    }

    if (av === bv) return 0;
    const cmp = av < bv ? -1 : 1;
    return dir === "asc" ? cmp : -cmp;
  }

  const sortState = { by: "", dir: "", manual: false };

  function setSort(by, dir){
    sortState.by = by;
    sortState.dir = dir;
    sortState.manual = true;

    const allBtns = ["sortIssuedAsc","sortIssuedDesc","sortCmdAsc","sortCmdDesc"].map(id => document.getElementById(id));
    allBtns.forEach(b => b.classList.remove("active"));

    if(by === "issuedAt" && dir === "asc") document.getElementById("sortIssuedAsc").classList.add("active");
    if(by === "issuedAt" && dir === "desc") document.getElementById("sortIssuedDesc").classList.add("active");
    if(by === "lastCommandAt" && dir === "asc") document.getElementById("sortCmdAsc").classList.add("active");
    if(by === "lastCommandAt" && dir === "desc") document.getElementById("sortCmdDesc").classList.add("active");
  }

  function setSortAuto(by, dir){
    sortState.by = by;
    sortState.dir = dir;
    sortState.manual = false;

    const allBtns = ["sortIssuedAsc","sortIssuedDesc","sortCmdAsc","sortCmdDesc"].map(id => document.getElementById(id));
    allBtns.forEach(b => b.classList.remove("active"));

    if(by === "issuedAt" && dir === "asc") document.getElementById("sortIssuedAsc").classList.add("active");
    if(by === "issuedAt" && dir === "desc") document.getElementById("sortIssuedDesc").classList.add("active");
    if(by === "lastCommandAt" && dir === "asc") document.getElementById("sortCmdAsc").classList.add("active");
    if(by === "lastCommandAt" && dir === "desc") document.getElementById("sortCmdDesc").classList.add("active");
  }

  // --- klíčová logika pro "když kliknu do jména/držitele a dám Enter/Filtr => vždy řaď podle jména"
  let forceNameSortOnce = false;

  ["fUserName","fHolder"].forEach(id => {
    const inp = document.getElementById(id);
    if (!inp) return;
    inp.addEventListener("focus", () => { forceNameSortOnce = true; });
  });

  function applyFilters(resetPage = true, forceNameSort = false){
    const fUserName = normalize(el("fUserName").value);
    const fVS       = normalize(el("fVS").value);
    const fHolder   = normalize(el("fHolder").value);
    const fCard      = normalize(el("fCard").value);
    const fStatus    = el("fStatus").value;

    const issuedFrom = el("fIssuedFrom").value;
    const issuedTo   = el("fIssuedTo").value;

    const cmdFrom    = el("fLastCmdFrom").value;
    const cmdTo      = el("fLastCmdTo").value;

    const nameFilterActive = fUserName.length > 0 || fHolder.length > 0;

    // 1) Vynucené řazení podle jména jen když si to user vyžádal (focus + Enter/Filtr)
    if (forceNameSort && nameFilterActive) {
      setSortAuto("userNameSurname", "asc");
      forceNameSortOnce = false;
    } else {
      // 2) auto-sort jen pokud není manual
      if (!sortState.manual) {
        if (nameFilterActive) setSortAuto("userNameSurname", "asc");
        else setSortAuto("lastCommandAt", "desc");
      }
    }

    let rows = ALL_ROWS.filter(r => {
      if (fUserName && !normalize(r.userName).includes(fUserName)) return false;
      if (fVS && !normalize(r.vs).includes(fVS)) return false;
      if (fHolder && !normalize(r.holderName).includes(fHolder)) return false;
      if (fCard && !normalize(r.cardMasked).includes(fCard)) return false;
      if (fStatus && r.status !== fStatus) return false;

      if (!inRange(r.issuedAt, issuedFrom, issuedTo)) return false;
      if (!inRange(r.lastCommandAt, cmdFrom, cmdTo)) return false;

      return true;
    });

    if (sortState.by){
      rows.sort((a,b) => compareWithNA(sortState.by, sortState.dir, a, b));
    }

    VIEW_ROWS = rows;
    if (resetPage) currentPage = 1;
    renderCurrentPage();
  }

  function isoTodayMinusMonths(months){
    const d = new Date();
    d.setMonth(d.getMonth() - months);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }

  // Nepoužité: N/A + vydané starší než 6 měsíců
  document.getElementById("btnUnused").addEventListener("click", () => {
    forceNameSortOnce = false;

    el("fUserName").value = "";
    el("fVS").value = "";
    el("fHolder").value = "";
    el("fCard").value = "";
    el("fStatus").value = "";

    const cutoff = isoTodayMinusMonths(6);

    el("fIssuedFrom").value = "";
    el("fIssuedTo").value = cutoff;

    el("fLastCmdFrom").value = "";
    el("fLastCmdTo").value = "";

    setSort("issuedAt", "asc");
    applyFilters(true, false);
  });

  function resetFilters(){
    el("fUserName").value = "";
    el("fVS").value = "";
    el("fHolder").value = "";
    el("fCard").value = "";
    el("fStatus").value = "";

    el("fIssuedFrom").value = "";
    el("fIssuedTo").value = "";
    el("fLastCmdFrom").value = "";
    el("fLastCmdTo").value = "";

    setSort("", "");
    setSortAuto("lastCommandAt", "desc");

    VIEW_ROWS = [...ALL_ROWS];
    currentPage = 1;
    renderCurrentPage();
  }

  // Filtr / Reset
  document.getElementById("btnFilter").addEventListener("click", () => applyFilters(true, forceNameSortOnce));
  document.getElementById("btnReset").addEventListener("click", resetFilters);

  // ENTER v jakémkoliv filtru = spustí Filtr
  document.querySelectorAll(".filters-row input, .filters-row select").forEach(elm => {
    elm.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        const activeId = document.activeElement && document.activeElement.id;
        const force = (activeId === "fUserName" || activeId === "fHolder") ? true : forceNameSortOnce;
        applyFilters(true, force);
      }
    });
  });

  (function markActiveMenu(){
    const path = (location.pathname || "/").toLowerCase();

    const byPath = (a) => {
      const href = (a.getAttribute("href") || "").toLowerCase();
      if(!href || href === "#") return false;
      return path === href || (path.startsWith(href.endsWith("/") ? href : href + "/"));
    };

    const links = Array.from(document.querySelectorAll(".menu a[href]"));
    let active = links.find(byPath);

    // fallback pro file:// (lokální soubor)
    if(!active){
      active = links.find(a => a.getAttribute("data-nav") === "cards"); // <-- tady je rozdíl
    }

    if(active) active.classList.add("active");
  })();



  // Sort arrow clicks => rovnou applyFilters (bez dalšího klikání na Filtr)
  document.getElementById("sortIssuedAsc").addEventListener("click", () => {
    forceNameSortOnce = false;
    setSort("issuedAt","asc");
    applyFilters(true, false);
  });
  document.getElementById("sortIssuedDesc").addEventListener("click", () => {
    forceNameSortOnce = false;
    setSort("issuedAt","desc");
    applyFilters(true, false);
  });
  document.getElementById("sortCmdAsc").addEventListener("click", () => {
    forceNameSortOnce = false;
    setSort("lastCommandAt","asc");
    applyFilters(true, false);
  });
  document.getElementById("sortCmdDesc").addEventListener("click", () => {
    forceNameSortOnce = false;
    setSort("lastCommandAt","desc");
    applyFilters(true, false);
  });

  // Sidebar hamburger toggle
  document.getElementById("hamburger").addEventListener("click", () => {
    document.body.classList.toggle("sidebar-collapsed");
  });

  // demo: nenecháme to nikam navigovat
  document.addEventListener("click", (e) => {
    const a = e.target.closest("a[data-noop]");
    if(a) e.preventDefault();
  });

  // start
  setSortAuto("lastCommandAt","desc");
  applyFilters(true, false);
</script>
</body>
